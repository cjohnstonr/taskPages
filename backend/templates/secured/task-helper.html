<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Helper - Escalation & Management</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- DOMPurify for sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      /* Reused from wait-node - Accordion animations */
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }

      .accordion-content.show {
        max-height: 5000px;
        transition: max-height 0.5s ease-in;
      }

      /* Reused from wait-node - Loading spinner */
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #10b981;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Reused from wait-node - Markdown content styling */
      .markdown-content h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 1rem;
        margin-top: 1.5rem;
        color: #1f2937;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0.5rem;
      }

      .markdown-content h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        margin-top: 1.25rem;
        color: #374151;
      }

      .markdown-content h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        margin-top: 1rem;
        color: #4b5563;
      }

      .markdown-content p {
        margin-bottom: 1rem;
        line-height: 1.7;
        color: #4b5563;
      }

      .markdown-content code {
        background-color: #f3f4f6;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        color: #dc2626;
      }

      .markdown-content pre {
        background-color: #1f2937;
        color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 1rem;
      }

      /* Action module styles */
      .action-tab {
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
      }

      .action-tab.active {
        border-bottom-color: #10b981;
        background-color: #ecfdf5;
      }

      /* Escalation form styles */
      .escalation-form {
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      }

      /* AI summary box */
      .ai-summary-box {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 2px dashed #3b82f6;
      }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
{% raw %}
    const { useState, useEffect, useMemo } = React;

    // Configuration - Using Python backend
    const BACKEND_URL = window.location.origin;

    // Custom field IDs - Reused from wait-node + new escalation fields
    const FIELD_IDS = {
        // Existing fields from wait-node
        PROCESS_TEXT: 'b2587292-c1bc-4ee0-8dcb-a69db68d5fe8',
        STEP_INSIGHTS: 'd6fe462e-d163-488a-af80-7861c42c789b',
        STEP_NUMBER: '68441ecb-470b-441c-ae24-916688595c05',
        EXECUTED: '13d4d660-432d-4033-9805-2ffc7d793c92',
        LIBRARY_LEVEL: 'e49ccff6-f042-4e47-b452-0812ba128cfb',
        
        // NEW: Escalation-specific fields (real ClickUp field IDs)
        ESCALATION_REASON: 'c6e0281e-9001-42d7-a265-8f5da6b71132',
        ESCALATION_AI_SUMMARY: 'e9e831f2-b439-4067-8e88-6b715f4263b2',
        ESCALATION_STATUS: '8d784bd0-18e5-4db3-b45e-9a2900262e04',
        ESCALATED_TO: '934811f1-239f-4d53-880c-3655571fd02e',
        ESCALATION_TIMESTAMP: '5ffd2b3e-b8dc-4bd0-819a-a3d4c3396a5f',
        SUPERVISOR_RESPONSE: 'a077ecc9-1a59-48af-b2cd-42a63f5a7f86',
        ESCALATION_RESOLVED_TIMESTAMP: 'c40bf1c4-7d33-4b2b-8765-0784cd88591a'
    };

    // Reused from wait-node - Helper function to extract URL parameters
    function getUrlParams() {
        const searchParams = window.location.search ?
            new URLSearchParams(window.location.search) :
            new URLSearchParams(window.parent?.location.search || '');

        const params = {};
        for (const [key, value] of searchParams.entries()) {
            params[key] = value.trim();
        }
        return params;
    }

    // Reused from wait-node - Helper to find custom field value
    function getCustomField(task, fieldId) {
        if (!task || !task.custom_fields) return null;
        const field = task.custom_fields.find(f => f.id === fieldId);
        return field?.value || field?.value_richtext || null;
    }

    // Reused from wait-node - Helper to format custom field value based on type
    function formatCustomFieldValue(field) {
        if (!field || field.value === null || field.value === undefined || field.value === '') return null;
        
        switch(field.type) {
            case 'checkbox':
                return field.value ? '✅ Yes' : '❌ No';
            
            case 'drop_down':
                const options = field?.type_config?.options || [];
                const selectedOption = options.find(opt => opt.orderindex === field.value);
                return selectedOption?.name || `Option ${field.value}`;
            
            case 'text':
            case 'short_text':
                const text = String(field.value);
                return text.length > 100 ? text.substring(0, 100) + '...' : text;
            
            case 'number':
                return String(field.value);
            
            case 'date':
                return field.value ? new Date(field.value).toLocaleDateString() : 'No date';
            
            case 'tasks':
                if (Array.isArray(field.value) && field.value.length > 0) {
                    return field.value.map(t => t.name || t.id).join(', ');
                }
                return 'No linked tasks';
            
            default:
                return String(field.value);
        }
    }

    // Reused from wait-node - Render markdown
    function renderMarkdown(text) {
        if (!text) return '';
        return DOMPurify.sanitize(marked.parse(text));
    }

    // Reused from wait-node - Date formatting
    const formatDate = (timestamp) => {
        if (!timestamp) return 'Not set';
        const date = new Date(parseInt(timestamp));
        return date.toLocaleString();
    };

    // Reused from wait-node - Backend API Service
    class TaskHelperAPI {
        constructor() {
            this.baseUrl = BACKEND_URL;
        }

        async checkAuthentication() {
            try {
                const res = await fetch('/auth/status', {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (res.status === 401) {
                    console.log('Not authenticated, redirecting to login...');
                    window.location.href = '/auth/login';
                    return false;
                }
                
                const data = await res.json();
                if (data.authenticated) {
                    console.log('Authenticated via session cookie');
                    return true;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
            
            window.location.href = '/auth/login';
            return false;
        }

        async request(endpoint, options = {}) {
            try {
                const response = await fetch(`${this.baseUrl}${endpoint}`, {
                    ...options,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (response.status === 401) {
                    console.error('Authentication failed, redirecting to login...');
                    window.location.href = '/auth/login';
                    throw new Error('Authentication failed');
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${JSON.stringify(errorData)}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Task Helper API request failed:', error);
                throw error;
            }
        }

        // Reuse wait-node initialization endpoint for task hierarchy
        async initializeTaskHelper(taskId) {
            return this.request(`/api/wait-node/initialize/${taskId}`);
        }

        // New endpoint for escalation submission
        async submitEscalation(taskId, escalationData) {
            return this.request(`/api/task-helper/escalate/${taskId}`, {
                method: 'POST',
                body: JSON.stringify(escalationData)
            });
        }

        // New endpoint for AI summary generation
        async generateAISummary(taskId, reason, taskContext) {
            return this.request('/api/ai/generate-escalation-summary', {
                method: 'POST',
                body: JSON.stringify({
                    task_id: taskId,
                    reason: reason,
                    context: taskContext
                })
            });
        }
    }

    // Create global API instance
    const api = new TaskHelperAPI();

    // Action Tabs Component
    function ActionTabs({ activeAction, onActionChange, availableActions }) {
        return (
            <div className="bg-white border-b border-gray-200">
                <div className="flex overflow-x-auto">
                    {availableActions.map(action => (
                        <button
                            key={action.id}
                            onClick={() => onActionChange(action.id)}
                            className={`action-tab px-6 py-4 font-medium text-sm whitespace-nowrap ${
                                activeAction === action.id
                                    ? 'active text-emerald-700'
                                    : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
                            }`}
                        >
                            <span className="mr-2">{action.icon}</span>
                            {action.name}
                        </button>
                    ))}
                </div>
            </div>
        );
    }

    // Task Display Component - Adapted from wait-node
    function TaskDisplay({ task, parentTask, hierarchy }) {
        const [expandedContext, setExpandedContext] = useState(false);

        if (!task) return null;

        return (
            <div className="bg-white border-b border-gray-200 p-6">
                <div className="mb-4">
                    <h1 className="text-2xl font-bold text-gray-900">{task.name}</h1>
                    {task.custom_id && (
                        <div className="flex items-center mt-2 space-x-4">
                            <span className="text-sm text-gray-500">
                                Task: <span className="font-mono text-gray-700">{task.custom_id}</span>
                            </span>
                            <a
                                href={`https://app.clickup.com/t/${task.id}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-sm text-blue-600 hover:text-blue-800 hover:underline"
                            >
                                Open in ClickUp ↗
                            </a>
                        </div>
                    )}
                </div>

                {/* Task Status & Priority */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <div className="text-xs text-gray-500 uppercase tracking-wider">Status</div>
                        <div className="mt-1">
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                  style={{ backgroundColor: task.status?.color + '20', color: task.status?.color }}>
                                {task.status?.status || 'Unknown'}
                            </span>
                        </div>
                    </div>
                    
                    <div>
                        <div className="text-xs text-gray-500 uppercase tracking-wider">Priority</div>
                        <div className="mt-1 text-sm text-gray-900">
                            {task.priority?.priority || 'None'}
                        </div>
                    </div>

                    <div>
                        <div className="text-xs text-gray-500 uppercase tracking-wider">Assignees</div>
                        <div className="mt-1 text-sm text-gray-900">
                            {task.assignees?.length > 0 
                                ? task.assignees.map(a => a.username).join(', ')
                                : 'Unassigned'
                            }
                        </div>
                    </div>

                    <div>
                        <div className="text-xs text-gray-500 uppercase tracking-wider">Due Date</div>
                        <div className="mt-1 text-sm text-gray-900">
                            {task.due_date ? formatDate(task.due_date) : 'No due date'}
                        </div>
                    </div>
                </div>

                {/* Expandable Task Description */}
                {task.description && (
                    <div className="border-t border-gray-200 pt-4">
                        <button
                            onClick={() => setExpandedContext(!expandedContext)}
                            className="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                        >
                            <div className="flex items-center justify-between">
                                <h3 className="text-sm font-semibold text-gray-700">
                                    📋 Task Description
                                </h3>
                                <span className={`text-gray-400 transition-transform duration-200 ${
                                    expandedContext ? 'rotate-180' : ''
                                }`}>
                                    ▼
                                </span>
                            </div>
                        </button>
                        
                        <div className={`accordion-content ${expandedContext ? 'show' : ''}`}>
                            {expandedContext && (
                                <div className="mt-3 p-4 bg-white border border-gray-200 rounded-lg">
                                    <div
                                        className="markdown-content text-sm text-gray-700"
                                        dangerouslySetInnerHTML={{
                                            __html: renderMarkdown(task.description)
                                        }}
                                    />
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* Hierarchy Context - Show parent if exists */}
                {parentTask && (
                    <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div className="text-xs text-blue-600 uppercase tracking-wider mb-1">Parent Task</div>
                        <a
                            href={`https://app.clickup.com/t/${parentTask.id}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-blue-700 hover:text-blue-900 font-medium text-sm"
                        >
                            {parentTask.name}
                        </a>
                        {parentTask.custom_id && (
                            <span className="ml-2 text-xs text-blue-600 font-mono">
                                {parentTask.custom_id}
                            </span>
                        )}
                    </div>
                )}
            </div>
        );
    }

    // Comments Section - Full-featured from wait-node
    function CommentsSection({ task }) {
        const [comments, setComments] = useState([]);
        const [loading, setLoading] = useState(false);
        const [hasMore, setHasMore] = useState(false);
        const [expanded, setExpanded] = useState(false);
        const [expandedComments, setExpandedComments] = useState(new Set());

        // Fetch comments when component mounts or task changes
        useEffect(() => {
            if (task && task.id) {
                loadInitialComments();
            }
        }, [task]);

        const loadInitialComments = async () => {
            if (!task || !task.id) {
                console.warn('⚠️ [TASK COMMENTS] No task or ID available');
                return;
            }
            
            const commentsUrl = `${BACKEND_URL}/api/task/${task.id}/comments?limit=5`;
            console.log('🔍 [TASK COMMENTS] API URL:', commentsUrl);
            
            setLoading(true);
            try {
                // Use session cookie authentication
                const response = await fetch(commentsUrl, {
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                console.log('🔍 [TASK COMMENTS] Response status:', response.status);
                
                if (response.status === 401) {
                    console.warn('⚠️ [TASK COMMENTS] 401 Unauthorized, redirecting to login');
                    window.location.href = '/auth/login';
                    return;
                }
                if (response.ok) {
                    const data = await response.json();
                    console.log('🔍 [TASK COMMENTS] Response data:', data);
                    setComments(data.comments || []);
                    setHasMore(data.has_more || false);
                } else {
                    const errorText = await response.text();
                    console.error('❌ [TASK COMMENTS] Failed to fetch comments:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('❌ [TASK COMMENTS] Error fetching comments:', error);
            } finally {
                setLoading(false);
            }
        };

        const loadMoreComments = async () => {
            if (!task || !task.id || loading) return;
            
            setLoading(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/task/${task.id}/comments?start=${comments.length}&limit=5`, {
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                if (response.status === 401) {
                    window.location.href = '/auth/login';
                    return;
                }
                if (response.ok) {
                    const data = await response.json();
                    setComments(prev => [...prev, ...(data.comments || [])]);
                    setHasMore(data.has_more || false);
                }
            } catch (error) {
                console.error('Error loading more comments:', error);
            } finally {
                setLoading(false);
            }
        };

        const toggleCommentExpansion = (commentId) => {
            setExpandedComments(prev => {
                const newSet = new Set(prev);
                if (newSet.has(commentId)) {
                    newSet.delete(commentId);
                } else {
                    newSet.add(commentId);
                }
                return newSet;
            });
        };

        if (!task) return null;

        return (
            <div className="border-t border-gray-200 bg-white">
                <div 
                    className="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                    onClick={() => setExpanded(!expanded)}
                >
                    <div className="flex items-center justify-between">
                        <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            💬 Recent Activity
                            {comments.length > 0 && (
                                <span className="ml-2 bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs font-normal">
                                    {comments.length}
                                </span>
                            )}
                        </h3>
                        <svg 
                            className={`w-4 h-4 text-gray-400 transition-transform ${expanded ? 'rotate-90' : ''}`}
                            fill="none" 
                            stroke="currentColor" 
                            viewBox="0 0 24 24"
                        >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                </div>

                {expanded && (
                    <div className="px-4 pb-4">
                        {loading && comments.length === 0 ? (
                            <div className="text-center py-4 text-gray-500 text-sm">
                                Loading comments...
                            </div>
                        ) : comments.length === 0 ? (
                            <div className="text-center py-4 text-gray-500 text-sm">
                                No comments yet
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {comments.map((comment) => (
                                    <div key={comment.id} className="border-l-2 border-gray-200 pl-3">
                                        <div className="flex items-start gap-2">
                                            <div 
                                                className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium text-white flex-shrink-0"
                                                style={{ backgroundColor: comment.user.color || '#808080' }}
                                            >
                                                {comment.user.initials}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 text-xs text-gray-500">
                                                    <span className="font-medium">{comment.user.username}</span>
                                                    <span>•</span>
                                                    <span>{comment.date_formatted}</span>
                                                </div>
                                                <div className="text-sm text-gray-700 mt-1 break-words">
                                                    {comment.text.length > 100 ? (
                                                        <>
                                                            {expandedComments.has(comment.id) 
                                                                ? comment.text 
                                                                : `${comment.text.substring(0, 100)}...`
                                                            }
                                                            <button 
                                                                onClick={() => toggleCommentExpansion(comment.id)}
                                                                className="text-blue-600 text-xs ml-1 hover:underline cursor-pointer"
                                                            >
                                                                {expandedComments.has(comment.id) ? 'show less' : 'show more'}
                                                            </button>
                                                        </>
                                                    ) : (
                                                        comment.text
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}

                                {hasMore && (
                                    <div className="text-center pt-2">
                                        <button
                                            onClick={loadMoreComments}
                                            disabled={loading}
                                            className="text-xs text-blue-600 hover:text-blue-800 hover:underline disabled:opacity-50"
                                        >
                                            {loading ? 'Loading...' : 'Load more'}
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    }

    // Escalation Module - NEW COMPONENT
    function EscalationModule({ task, parentTask, subtasks, onEscalationComplete }) {
        const [escalationReason, setEscalationReason] = useState('');
        const [aiSummary, setAiSummary] = useState('');
        const [isGenerating, setIsGenerating] = useState(false);
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [step, setStep] = useState('reason'); // 'reason', 'summary', 'confirm'

        const generateAISummary = async () => {
            if (!escalationReason.trim()) {
                alert('Please provide a reason for escalation first.');
                return;
            }

            setIsGenerating(true);
            try {
                // Prepare context for AI
                const taskContext = {
                    task: task,
                    parent_task: parentTask,
                    subtasks: subtasks || [],
                    comments_count: 0 // Could load comment count
                };

                const response = await api.generateAISummary(task.id, escalationReason, taskContext);
                setAiSummary(response.summary);
                setStep('summary');
            } catch (error) {
                console.error('Failed to generate AI summary:', error);
                alert('Failed to generate AI summary. Please try again.');
            } finally {
                setIsGenerating(false);
            }
        };

        const submitEscalation = async () => {
            setIsSubmitting(true);
            try {
                const escalationData = {
                    reason: escalationReason,
                    ai_summary: aiSummary,
                    task_context: {
                        task_id: task.id,
                        task_name: task.name,
                        parent_task_id: parentTask?.id,
                        subtasks_count: subtasks?.length || 0
                    }
                };

                await api.submitEscalation(task.id, escalationData);
                
                setStep('confirm');
                if (onEscalationComplete) {
                    onEscalationComplete();
                }
            } catch (error) {
                console.error('Failed to submit escalation:', error);
                alert('Failed to submit escalation. Please try again.');
            } finally {
                setIsSubmitting(false);
            }
        };

        const resetEscalation = () => {
            setEscalationReason('');
            setAiSummary('');
            setStep('reason');
        };

        // Check if task is already escalated
        const escalationStatus = getCustomField(task, FIELD_IDS.ESCALATION_STATUS);
        if (escalationStatus === 'escalated') {
            const existingSummary = getCustomField(task, FIELD_IDS.ESCALATION_AI_SUMMARY);
            const escalationTimestamp = getCustomField(task, FIELD_IDS.ESCALATION_TIMESTAMP);
            
            return (
                <div className="escalation-form p-6 rounded-lg">
                    <div className="flex items-center mb-4">
                        <span className="text-2xl mr-3">✅</span>
                        <div>
                            <h3 className="text-lg font-semibold text-gray-900">Task Escalated</h3>
                            <p className="text-sm text-gray-600">
                                Escalated on {escalationTimestamp ? formatDate(escalationTimestamp) : 'Unknown date'}
                            </p>
                        </div>
                    </div>
                    
                    {existingSummary && (
                        <div className="ai-summary-box p-4 rounded-lg">
                            <h4 className="text-sm font-semibold text-blue-700 mb-2">📋 Escalation Summary</h4>
                            <div className="text-sm text-gray-700 whitespace-pre-wrap">
                                {existingSummary}
                            </div>
                        </div>
                    )}

                    <button
                        onClick={resetEscalation}
                        className="mt-4 text-sm text-blue-600 hover:text-blue-800"
                    >
                        Create New Escalation
                    </button>
                </div>
            );
        }

        return (
            <div className="escalation-form p-6 rounded-lg">
                <div className="flex items-center mb-6">
                    <span className="text-2xl mr-3">🚨</span>
                    <div>
                        <h3 className="text-lg font-semibold text-gray-900">Escalate Task</h3>
                        <p className="text-sm text-gray-600">
                            Provide context for why this task needs escalation
                        </p>
                    </div>
                </div>

                {step === 'reason' && (
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Why does this task need escalation? *
                            </label>
                            <textarea
                                value={escalationReason}
                                onChange={(e) => setEscalationReason(e.target.value)}
                                placeholder="Describe the issue, what you've tried, and what help you need..."
                                rows="4"
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                maxLength="1000"
                            />
                            <div className="text-xs text-gray-500 mt-1">
                                {escalationReason.length}/1000 characters
                            </div>
                        </div>

                        <button
                            onClick={generateAISummary}
                            disabled={!escalationReason.trim() || isGenerating}
                            className="w-full bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
                        >
                            {isGenerating ? (
                                <>
                                    <div className="spinner w-4 h-4"></div>
                                    <span>Generating AI Summary...</span>
                                </>
                            ) : (
                                <>
                                    <span>🤖</span>
                                    <span>Generate AI Summary</span>
                                </>
                            )}
                        </button>
                    </div>
                )}

                {step === 'summary' && (
                    <div className="space-y-4">
                        <div className="ai-summary-box p-4 rounded-lg">
                            <h4 className="text-sm font-semibold text-blue-700 mb-3">🤖 AI-Generated Summary</h4>
                            <div className="text-sm text-gray-700 whitespace-pre-wrap mb-4">
                                {aiSummary}
                            </div>
                        </div>

                        <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <h4 className="text-sm font-semibold text-yellow-700 mb-2">Review Before Sending</h4>
                            <p className="text-sm text-yellow-600">
                                This summary will be sent with your escalation. Make sure it accurately represents the issue.
                            </p>
                        </div>

                        <div className="flex space-x-3">
                            <button
                                onClick={() => setStep('reason')}
                                className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300"
                            >
                                ← Back to Edit
                            </button>
                            <button
                                onClick={submitEscalation}
                                disabled={isSubmitting}
                                className="flex-1 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 disabled:opacity-50 flex items-center justify-center space-x-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="spinner w-4 h-4"></div>
                                        <span>Escalating...</span>
                                    </>
                                ) : (
                                    <>
                                        <span>🚨</span>
                                        <span>Escalate Task</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                )}

                {step === 'confirm' && (
                    <div className="text-center space-y-4">
                        <div className="text-6xl">✅</div>
                        <h4 className="text-lg font-semibold text-gray-900">Escalation Submitted!</h4>
                        <p className="text-sm text-gray-600">
                            Your escalation has been submitted and the task has been marked for attention.
                        </p>
                    </div>
                )}
            </div>
        );
    }

    // Process Steps Accordion - Rich hierarchy from wait-node
    function ProcessStepsAccordion({ subtasks }) {
        const [expandedSteps, setExpandedSteps] = useState({});

        const handleExpand = (taskId) => {
            setExpandedSteps(prev => ({
                ...prev,
                [taskId]: !prev[taskId]
            }));
        };

        if (!subtasks || subtasks.length === 0) {
            return (
                <div className="bg-white border-b border-gray-200 p-6">
                    <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-5">
                        📝 Task Hierarchy
                    </h3>
                    <p className="text-gray-400 italic font-light">No subtasks found</p>
                </div>
            );
        }

        return (
            <div className="bg-white border-b border-gray-200 p-6">
                <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-5 flex items-center gap-3">
                    📝 Task Hierarchy
                    <span className="ml-auto text-sm font-normal text-gray-500">{subtasks.length} total subtasks</span>
                </h3>

                <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
                    {subtasks.map((subtask) => {
                        const stepNumber = getCustomField(subtask, FIELD_IDS.STEP_NUMBER) || '?';
                        const stepInsights = getCustomField(subtask, FIELD_IDS.STEP_INSIGHTS);
                        const executed = getCustomField(subtask, FIELD_IDS.EXECUTED);
                        const hasContent = stepInsights || subtask.description;
                        const stepName = subtask?.name || ''

                        const libraryLevelObj = subtask.custom_fields?.find(e=>e.id === FIELD_IDS.LIBRARY_LEVEL)
                        const libraryLevelValue = libraryLevelObj?.value || null;
                        const optionsLibrary = libraryLevelObj?.type_config?.options || [];
                        const elibrary = optionsLibrary.find(e => e.orderindex === libraryLevelValue)
                        const libraryLevel = elibrary?.name || ''

                        const isDeleted = subtask.status?.status === 'deleted' || subtask.archived;
                        
                        return (
                            <div key={subtask.id} className={`border border-gray-200 rounded-lg overflow-hidden shadow-sm ${isDeleted ? 'opacity-50' : ''}`}>
                                <button
                                    onClick={() => handleExpand(subtask.id)}
                                    className={`w-full px-4 py-3 text-left ${isDeleted ? 'bg-gray-100' : 'bg-white hover:bg-gray-50'} focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-inset transition-colors duration-200 ${
                                        expandedSteps[subtask.id] && !isDeleted ? 'bg-emerald-50' : ''
                                    }`}
                                    disabled={isDeleted}
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-3 flex-1 min-w-0">
                                            <span className={`text-lg ${executed ? 'text-emerald-600' : 'text-gray-400'}`}>
                                                {executed ? '✅' : libraryLevel === 'Wait' ? '⏳' : '❌'}
                                            </span>
                                            <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">
                                                {stepNumber ? `Step ${stepNumber}` : 'Subtask'}
                                            </span>
                                            {subtask.custom_id && (
                                                <a
                                                    href={`https://app.clickup.com/t/${subtask.id}`}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    onClick={(e) => e.stopPropagation()}
                                                    className="text-xs text-blue-600 hover:text-blue-800 hover:underline font-mono transition-colors duration-200"
                                                    title={`Open task ${subtask.custom_id} in ClickUp`}
                                                >
                                                    {subtask.custom_id}
                                                </a>
                                            )}
                                            {stepName && (
                                                <span className="text-sm text-gray-700 truncate" title={stepName}>
                                                    {stepName}
                                                </span>
                                            )}
                                        </div>
                                        <div className="flex items-center space-x-2 flex-shrink-0">
                                            {hasContent && (
                                                <span className={`text-xs transition-transform duration-200 ${
                                                    expandedSteps[subtask.id] ? 'rotate-180' : ''
                                                }`}>
                                                    ▼
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </button>

                                {/* Expanded content */}
                                {expandedSteps[subtask.id] && hasContent && (
                                    <div className="px-4 pb-4 bg-gray-50">
                                        {/* Task description */}
                                        {subtask.description && (
                                            <div className="mb-3">
                                                <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
                                                    Description
                                                </h4>
                                                <div 
                                                    className="markdown-content text-sm text-gray-700 bg-white p-3 rounded border"
                                                    dangerouslySetInnerHTML={{
                                                        __html: renderMarkdown(subtask.description)
                                                    }}
                                                />
                                            </div>
                                        )}

                                        {/* Step insights */}
                                        {stepInsights && (
                                            <div className="mb-3">
                                                <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
                                                    Step Insights
                                                </h4>
                                                <div className="text-sm text-gray-700 bg-white p-3 rounded border font-mono whitespace-pre-wrap">
                                                    {stepInsights}
                                                </div>
                                            </div>
                                        )}

                                        {/* Task metadata */}
                                        <div className="grid grid-cols-2 gap-4 text-xs">
                                            <div>
                                                <span className="text-gray-500">Status:</span>
                                                <span className="ml-1 font-medium" style={{color: subtask.status?.color}}>
                                                    {subtask.status?.status || 'Unknown'}
                                                </span>
                                            </div>
                                            <div>
                                                <span className="text-gray-500">Priority:</span>
                                                <span className="ml-1 font-medium">
                                                    {subtask.priority?.priority || 'None'}
                                                </span>
                                            </div>
                                            {subtask.assignees?.length > 0 && (
                                                <div>
                                                    <span className="text-gray-500">Assignees:</span>
                                                    <span className="ml-1 font-medium">
                                                        {subtask.assignees.map(a => a.username).join(', ')}
                                                    </span>
                                                </div>
                                            )}
                                            {subtask.due_date && (
                                                <div>
                                                    <span className="text-gray-500">Due:</span>
                                                    <span className="ml-1 font-medium">
                                                        {formatDate(subtask.due_date)}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    }

    // Main Task Helper App
    function TaskHelperApp() {
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [task, setTask] = useState(null);
        const [parentTask, setParentTask] = useState(null);
        const [subtasks, setSubtasks] = useState([]);
        const [hierarchyInfo, setHierarchyInfo] = useState(null);
        const [activeAction, setActiveAction] = useState('escalate');
        const [isMobile, setIsMobile] = useState(false);

        // Available action modules
        const availableActions = [
            { id: 'escalate', name: 'Escalate', icon: '🚨' },
            // Future actions can be added here
            // { id: 'quick-edit', name: 'Quick Edit', icon: '✏️' },
            // { id: 'communicate', name: 'Send Update', icon: '📧' }
        ];

        // Reused from wait-node - Mobile detection
        useEffect(() => {
            const checkMobile = () => {
                setIsMobile(window.innerWidth < 768);
            };
            checkMobile();
            window.addEventListener('resize', checkMobile);
            return () => window.removeEventListener('resize', checkMobile);
        }, []);

        useEffect(() => {
            initializeApp();
        }, []);

        // Reused from wait-node - App initialization
        async function initializeApp() {
            try {
                setLoading(true);
                setError(null);

                // Check authentication
                if (!await api.checkAuthentication()) {
                    return;
                }

                // Get task ID from URL
                const params = getUrlParams();
                const taskId = params.task_id;

                if (!taskId) {
                    throw new Error('No task_id parameter provided. Please provide ?task_id=TASK_ID in URL.');
                }

                console.log('Initializing Task Helper for task:', taskId);

                // Fetch task hierarchy data (reusing wait-node endpoint)
                const data = await api.initializeTaskHelper(taskId);
                
                if (!data.main_task && !data.wait_task) {
                    throw new Error('Task not found or inaccessible');
                }

                // Set state from response
                const mainTask = data.main_task || data.wait_task;
                setTask(mainTask);
                setParentTask(data.parent_task);
                setSubtasks(data.subtasks || []);
                setHierarchyInfo(data.hierarchy);

                console.log('Task Helper initialized successfully');

            } catch (err) {
                console.error('Task Helper initialization error:', err);
                setError(`Failed to load task data: ${err.message}`);
            } finally {
                setLoading(false);
            }
        }

        // Reused from wait-node - Loading state
        if (loading) {
            return (
                <div className="min-h-screen flex items-center justify-center">
                    <div className="text-center">
                        <div className="spinner mx-auto mb-4"></div>
                        <p className="text-gray-600">Loading Task Helper...</p>
                    </div>
                </div>
            );
        }

        // Reused from wait-node - Error state
        if (error) {
            return (
                <div className="min-h-screen flex items-center justify-center">
                    <div className="max-w-md p-6 bg-red-50 border border-red-200 rounded-lg">
                        <h2 className="text-xl font-semibold text-red-800 mb-2">Error</h2>
                        <p className="text-red-700">{error}</p>
                        <button
                            onClick={initializeApp}
                            className="mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                        >
                            Retry
                        </button>
                    </div>
                </div>
            );
        }

        return (
            <div className="min-h-screen bg-gray-100">
                {/* Header */}
                <div className="bg-white shadow-sm border-b">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex items-center justify-between h-16">
                            <div className="flex items-center">
                                <h1 className="text-xl font-semibold text-gray-900">Task Helper</h1>
                                {task?.custom_id && (
                                    <span className="ml-3 text-sm text-gray-500 font-mono">
                                        {task.custom_id}
                                    </span>
                                )}
                            </div>
                            <div className="text-sm text-gray-500">
                                {isMobile ? 'Mobile View' : 'Desktop View'}
                            </div>
                        </div>
                    </div>
                </div>

                {/* Action Tabs */}
                <ActionTabs 
                    activeAction={activeAction}
                    onActionChange={setActiveAction}
                    availableActions={availableActions}
                />

                {/* Main Content */}
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <div className="bg-white rounded-lg shadow">
                        {/* Task Display */}
                        <TaskDisplay 
                            task={task}
                            parentTask={parentTask}
                            hierarchy={hierarchyInfo}
                        />

                        {/* Action Module - Currently only Escalation */}
                        {activeAction === 'escalate' && (
                            <EscalationModule 
                                task={task}
                                parentTask={parentTask}
                                subtasks={subtasks}
                                onEscalationComplete={() => {
                                    // Refresh task data to show updated escalation status
                                    initializeApp();
                                }}
                            />
                        )}

                        {/* Comments Section */}
                        <CommentsSection task={task} />

                        {/* Process Steps / Subtasks Hierarchy */}
                        <ProcessStepsAccordion subtasks={subtasks} />

                        {/* Summary Stats */}
                        <div className="p-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                            <div className="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div className="text-2xl font-bold text-gray-900">
                                        {subtasks?.length || 0}
                                    </div>
                                    <div className="text-sm text-gray-600">Subtasks</div>
                                </div>
                                <div>
                                    <div className="text-2xl font-bold text-green-600">
                                        {subtasks?.filter(s => getCustomField(s, FIELD_IDS.EXECUTED)).length || 0}
                                    </div>
                                    <div className="text-sm text-gray-600">Completed</div>
                                </div>
                                <div>
                                    <div className="text-2xl font-bold text-blue-600">
                                        {task?.assignees?.length || 0}
                                    </div>
                                    <div className="text-sm text-gray-600">Assignees</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // Render the app
    ReactDOM.render(<TaskHelperApp />, document.getElementById('root'));

{% endraw %}
</script>
</body>
</html>