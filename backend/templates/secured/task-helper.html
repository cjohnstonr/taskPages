<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Helper - Escalation System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    {% raw %}
    const { useState, useEffect, useRef, useCallback, useMemo } = React;
    
    // Backend URL - Use the actual Render backend URL
    const BACKEND_URL = 'https://taskpages-backend.onrender.com';
    
    // Custom Field IDs - ALL 7 FIELDS FROM USER
    const FIELD_IDS = {
        // Escalation fields
        ESCALATION_REASON: 'c6e0281e-9001-42d7-a265-8f5da6b71132',
        ESCALATION_AI_SUMMARY: 'e9e831f2-b439-4067-8e88-6b715f4263b2',
        ESCALATION_STATUS: '8d784bd0-18e5-4db3-b45e-9a2900262e04',
        ESCALATED_TO: '934811f1-239f-4d53-880c-3655571fd02e',
        ESCALATION_TIMESTAMP: '5ffd2b3e-b8dc-4bd0-819a-a3d4c3396a5f',
        SUPERVISOR_RESPONSE: 'a077ecc9-1a59-48af-b2cd-42a63f5a7f86',
        ESCALATION_RESOLVED_TIMESTAMP: 'c40bf1c4-7d33-4b2b-8765-0784cd88591a'
    };

    // Helper to get custom field value
    function getCustomField(task, fieldId) {
        if (!task?.custom_fields) return null;
        const field = task.custom_fields.find(f => f.id === fieldId);
        return field?.value || null;
    }

    // Helper to get non-empty custom fields
    function getNonEmptyCustomFields(task) {
        if (!task?.custom_fields) return [];
        
        return task.custom_fields
            .filter(field => {
                // Skip escalation fields (shown separately)
                if (Object.values(FIELD_IDS).includes(field.id)) return false;
                // Skip empty values
                if (!field.value) return false;
                if (field.value === '') return false;
                if (field.value === 0 && field.type !== 'number') return false;
                return true;
            })
            .map(field => ({
                id: field.id,
                name: field.name,
                value: field.value,
                type: field.type
            }));
    }

    // Format custom field value for display
    function formatFieldValue(field) {
        if (field.type === 'date') {
            return new Date(field.value).toLocaleDateString();
        }
        if (field.type === 'number') {
            return field.value.toLocaleString();
        }
        if (field.type === 'drop_down') {
            // For dropdowns, value might be an object
            if (typeof field.value === 'object') {
                return field.value.name || field.value.value || 'Selected';
            }
        }
        return String(field.value);
    }

    // Task Details Panel - Shows task info cleanly
    function TaskDetailsPanel({ task, title = "Task Details", isParent = false }) {
        if (!task) return null;
        
        const nonEmptyFields = getNonEmptyCustomFields(task);
        const [expanded, setExpanded] = useState(!isParent); // Parent collapsed by default
        
        return (
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div 
                    className="px-4 py-3 bg-gray-50 border-b cursor-pointer hover:bg-gray-100 transition-colors"
                    onClick={() => setExpanded(!expanded)}
                >
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-2">
                            <span className="text-lg">{isParent ? '👆' : '📋'}</span>
                            <h3 className="text-sm font-semibold text-gray-700">{title}</h3>
                            <span className="text-xs text-gray-500">({task.name})</span>
                        </div>
                        <svg 
                            className={`w-4 h-4 text-gray-400 transition-transform ${expanded ? 'rotate-90' : ''}`}
                            fill="none" 
                            stroke="currentColor" 
                            viewBox="0 0 24 24"
                        >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                </div>
                
                {expanded && (
                    <div className="p-4 space-y-4">
                        {/* Task Name and Link */}
                        <div>
                            <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">
                                Task Name
                            </h4>
                            <div className="flex items-center gap-2">
                                <span className="text-sm text-gray-900">{task.name}</span>
                                {task.custom_id && (
                                    <a
                                        href={`https://app.clickup.com/t/${task.id}`}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="text-xs text-blue-600 hover:text-blue-800 font-mono"
                                    >
                                        {task.custom_id}
                                    </a>
                                )}
                            </div>
                        </div>
                        
                        {/* Description */}
                        {task.description && (
                            <div>
                                <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">
                                    Description
                                </h4>
                                <div className="text-sm text-gray-700 bg-gray-50 p-3 rounded">
                                    {task.description}
                                </div>
                            </div>
                        )}
                        
                        {/* Non-Empty Custom Fields */}
                        {nonEmptyFields.length > 0 && (
                            <div>
                                <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
                                    Custom Fields
                                </h4>
                                <div className="grid grid-cols-2 gap-3">
                                    {nonEmptyFields.map(field => (
                                        <div key={field.id} className="bg-gray-50 p-2 rounded">
                                            <div className="text-xs text-gray-500">{field.name}</div>
                                            <div className="text-sm text-gray-900 font-medium">
                                                {formatFieldValue(field)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Basic Info */}
                        <div className="grid grid-cols-2 gap-3 text-xs">
                            <div>
                                <span className="text-gray-500">Status:</span>
                                <span className="ml-1 font-medium" style={{color: task.status?.color}}>
                                    {task.status?.status || 'Unknown'}
                                </span>
                            </div>
                            {task.priority && (
                                <div>
                                    <span className="text-gray-500">Priority:</span>
                                    <span className="ml-1 font-medium">
                                        {task.priority.priority || 'None'}
                                    </span>
                                </div>
                            )}
                            {task.assignees?.length > 0 && (
                                <div>
                                    <span className="text-gray-500">Assignees:</span>
                                    <span className="ml-1 font-medium">
                                        {task.assignees.map(a => a.username).join(', ')}
                                    </span>
                                </div>
                            )}
                            {task.due_date && (
                                <div>
                                    <span className="text-gray-500">Due:</span>
                                    <span className="ml-1 font-medium">
                                        {new Date(task.due_date).toLocaleDateString()}
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // Smart Escalation Module - Changes based on state
    function EscalationModule({ task, parentTask, onRefresh }) {
        const [escalationText, setEscalationText] = useState('');
        const [aiSummary, setAiSummary] = useState('');
        const [supervisorText, setSupervisorText] = useState('');
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [isGenerating, setIsGenerating] = useState(false);
        
        // Get escalation field values
        const reason = getCustomField(task, FIELD_IDS.ESCALATION_REASON);
        const summary = getCustomField(task, FIELD_IDS.ESCALATION_AI_SUMMARY);
        const status = getCustomField(task, FIELD_IDS.ESCALATION_STATUS);
        const supervisorResponse = getCustomField(task, FIELD_IDS.SUPERVISOR_RESPONSE);
        const escalatedTo = getCustomField(task, FIELD_IDS.ESCALATED_TO);
        const escalationTime = getCustomField(task, FIELD_IDS.ESCALATION_TIMESTAMP);
        const resolvedTime = getCustomField(task, FIELD_IDS.ESCALATION_RESOLVED_TIMESTAMP);
        
        // Determine escalation state
        const isEscalated = reason || summary || (status && status !== 'not_escalated');
        const isResolved = supervisorResponse || (status === 'resolved');
        const isAwaitingResponse = isEscalated && !isResolved;
        
        // TODO: Check if current user is supervisor
        const isSupervisor = false; // This should be determined from user context
        
        // Generate AI Summary
        const generateSummary = async () => {
            if (!escalationText.trim()) {
                alert('Please provide an escalation reason first');
                return;
            }
            
            setIsGenerating(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/ai/generate-escalation-summary`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: task.id,
                        reason: escalationText,
                        context: {
                            task: task,
                            parent_task: parentTask
                        }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    setAiSummary(data.summary);
                } else {
                    alert('Failed to generate AI summary');
                }
            } catch (error) {
                console.error('Error generating summary:', error);
                alert('Error generating AI summary');
            } finally {
                setIsGenerating(false);
            }
        };
        
        // Submit Escalation
        const submitEscalation = async () => {
            setIsSubmitting(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/task-helper/escalate/${task.id}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: escalationText,
                        ai_summary: aiSummary,
                        escalated_to: '', // TODO: Add supervisor selection
                        task_context: {
                            task_id: task.id,
                            task_name: task.name,
                            parent_task_id: parentTask?.id
                        }
                    })
                });
                
                if (response.ok) {
                    alert('Escalation submitted successfully!');
                    // Refresh page to show updated state
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('Failed to submit escalation');
                }
            } catch (error) {
                console.error('Error submitting escalation:', error);
                alert('Error submitting escalation');
            } finally {
                setIsSubmitting(false);
            }
        };
        
        // Submit Supervisor Response
        const submitSupervisorResponse = async () => {
            setIsSubmitting(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/task-helper/supervisor-response/${task.id}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        response: supervisorText
                    })
                });
                
                if (response.ok) {
                    alert('Response recorded successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('Failed to submit response');
                }
            } catch (error) {
                console.error('Error submitting response:', error);
                alert('Error submitting response');
            } finally {
                setIsSubmitting(false);
            }
        };
        
        // RESOLVED STATE
        if (isResolved) {
            return (
                <div className="bg-green-50 rounded-lg p-6">
                    <div className="flex items-center mb-4">
                        <span className="text-2xl mr-3">✅</span>
                        <div>
                            <h3 className="text-lg font-semibold text-green-900">Escalation Resolved</h3>
                            <p className="text-sm text-green-700">
                                Resolved on {resolvedTime ? new Date(resolvedTime).toLocaleString() : 'Unknown'}
                            </p>
                        </div>
                    </div>
                    
                    <div className="space-y-4">
                        {reason && (
                            <div>
                                <h4 className="text-sm font-semibold text-gray-700 mb-1">Original Reason</h4>
                                <p className="text-sm text-gray-600 bg-white p-3 rounded">{reason}</p>
                            </div>
                        )}
                        
                        {supervisorResponse && (
                            <div>
                                <h4 className="text-sm font-semibold text-green-700 mb-1">Supervisor Response</h4>
                                <p className="text-sm text-gray-700 bg-white p-3 rounded">{supervisorResponse}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        // AWAITING RESPONSE STATE
        if (isAwaitingResponse) {
            return (
                <div className="bg-yellow-50 rounded-lg p-6">
                    <div className="flex items-center mb-4">
                        <span className="text-2xl mr-3">⏳</span>
                        <div>
                            <h3 className="text-lg font-semibold text-yellow-900">Escalation Pending</h3>
                            <p className="text-sm text-yellow-700">
                                Escalated on {escalationTime ? new Date(escalationTime).toLocaleString() : 'Unknown'}
                            </p>
                        </div>
                    </div>
                    
                    <div className="space-y-4">
                        {reason && (
                            <div>
                                <h4 className="text-sm font-semibold text-gray-700 mb-1">Escalation Reason</h4>
                                <p className="text-sm text-gray-600 bg-white p-3 rounded">{reason}</p>
                            </div>
                        )}
                        
                        {summary && (
                            <div>
                                <h4 className="text-sm font-semibold text-blue-700 mb-1">AI Summary</h4>
                                <p className="text-sm text-gray-600 bg-white p-3 rounded">{summary}</p>
                            </div>
                        )}
                        
                        {/* Supervisor Response Form (if user is supervisor) */}
                        {isSupervisor && (
                            <div className="border-t pt-4">
                                <h4 className="text-sm font-semibold text-gray-700 mb-2">Provide Response</h4>
                                <textarea
                                    value={supervisorText}
                                    onChange={(e) => setSupervisorText(e.target.value)}
                                    className="w-full p-3 border rounded-md text-sm"
                                    rows="4"
                                    placeholder="Enter your response and instructions..."
                                />
                                <button
                                    onClick={submitSupervisorResponse}
                                    disabled={!supervisorText.trim() || isSubmitting}
                                    className="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                                >
                                    {isSubmitting ? 'Submitting...' : 'Submit Response'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        // NOT ESCALATED STATE - Show form
        return (
            <div className="bg-white rounded-lg p-6 border border-gray-200">
                <div className="flex items-center mb-4">
                    <span className="text-2xl mr-3">🚨</span>
                    <h3 className="text-lg font-semibold text-gray-900">Escalate Task</h3>
                </div>
                
                <div className="space-y-4">
                    {/* Step 1: Reason */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Why does this task need escalation?
                        </label>
                        <textarea
                            value={escalationText}
                            onChange={(e) => setEscalationText(e.target.value)}
                            className="w-full p-3 border rounded-md text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            rows="4"
                            placeholder="Describe the issue and why it needs attention..."
                        />
                    </div>
                    
                    {/* Step 2: AI Summary */}
                    {escalationText && (
                        <div>
                            <button
                                onClick={generateSummary}
                                disabled={isGenerating}
                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
                            >
                                {isGenerating ? 'Generating...' : '🤖 Generate AI Summary'}
                            </button>
                            
                            {aiSummary && (
                                <div className="mt-3 p-3 bg-blue-50 rounded">
                                    <h4 className="text-sm font-semibold text-blue-700 mb-1">AI Summary</h4>
                                    <p className="text-sm text-gray-700">{aiSummary}</p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Submit Button */}
                    {escalationText && aiSummary && (
                        <button
                            onClick={submitEscalation}
                            disabled={isSubmitting}
                            className="w-full px-4 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 font-semibold"
                        >
                            {isSubmitting ? 'Submitting...' : '🚨 Submit Escalation'}
                        </button>
                    )}
                </div>
            </div>
        );
    }

    // Main App Component
    function TaskHelperApp() {
        const [loading, setLoading] = useState(true);
        const [task, setTask] = useState(null);
        const [parentTask, setParentTask] = useState(null);
        const [error, setError] = useState(null);
        
        useEffect(() => {
            loadTaskData();
        }, []);
        
        async function loadTaskData() {
            try {
                // Get task ID from URL
                const params = new URLSearchParams(window.location.search);
                const taskId = params.get('task_id');
                
                if (!taskId) {
                    throw new Error('No task_id parameter provided');
                }
                
                // Fetch task data using task-helper initialization endpoint
                const response = await fetch(`${BACKEND_URL}/api/task-helper/initialize/${taskId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/auth/login';
                        return;
                    }
                    throw new Error('Failed to load task');
                }
                
                const data = await response.json();
                setTask(data.main_task || data.wait_task);
                setParentTask(data.parent_task);
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        }
        
        if (loading) {
            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                    <div className="text-center">
                        <div className="spinner mx-auto mb-4"></div>
                        <p className="text-gray-600">Loading task data...</p>
                    </div>
                </div>
            );
        }
        
        if (error) {
            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                    <div className="text-center text-red-600">
                        <p className="text-xl mb-2">Error</p>
                        <p>{error}</p>
                    </div>
                </div>
            );
        }
        
        return (
            <div className="min-h-screen bg-gray-50">
                {/* Header */}
                <div className="bg-white shadow-sm border-b">
                    <div className="max-w-6xl mx-auto px-4 py-4">
                        <h1 className="text-xl font-semibold text-gray-900">
                            🚨 Task Helper - Escalation System
                        </h1>
                    </div>
                </div>
                
                {/* Main Content */}
                <div className="max-w-6xl mx-auto px-4 py-6">
                    <div className="space-y-6">
                        {/* Parent Task (if exists) */}
                        {parentTask && (
                            <TaskDetailsPanel 
                                task={parentTask} 
                                title="Parent Task" 
                                isParent={true}
                            />
                        )}
                        
                        {/* Current Task */}
                        <TaskDetailsPanel 
                            task={task} 
                            title="Current Task" 
                            isParent={false}
                        />
                        
                        {/* Comments (if needed, can add CommentsSection here) */}
                        
                        {/* Escalation Module */}
                        <EscalationModule 
                            task={task} 
                            parentTask={parentTask}
                            onRefresh={loadTaskData}
                        />
                    </div>
                </div>
            </div>
        );
    }
    
    // Render the app
    ReactDOM.render(<TaskHelperApp />, document.getElementById('root'));
    {% endraw %}
    </script>
</body>
</html>