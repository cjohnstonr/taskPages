<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Helper - Escalation System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Fields Sidebar CSS -->
    <link rel="stylesheet" href="/static/custom-fields-sidebar.css">

    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Accordion animation for collapsible sections */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .accordion-content.show {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }
        
        /* Small spinner for loading states */
        .spinner-sm {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Custom Fields Sidebar Component -->
    <script src="/static/custom-fields-sidebar.js"></script>

    <script type="text/babel">
    {% raw %}
    const { useState, useEffect, useRef, useCallback, useMemo } = React;
    
    // Backend URL - Use the actual Render backend URL
    const BACKEND_URL = 'https://taskpages-backend.onrender.com';
    
    // Custom Field IDs - ALL 7 FIELDS FROM USER
    const FIELD_IDS = {
        // Escalation fields
        ESCALATION_REASON: 'c6e0281e-9001-42d7-a265-8f5da6b71132',
        ESCALATION_AI_SUMMARY: 'e9e831f2-b439-4067-8e88-6b715f4263b2',
        ESCALATION_STATUS: '8d784bd0-18e5-4db3-b45e-9a2900262e04',
        ESCALATED_TO: '934811f1-239f-4d53-880c-3655571fd02e',
        ESCALATION_TIMESTAMP: '5ffd2b3e-b8dc-4bd0-819a-a3d4c3396a5f',
        SUPERVISOR_RESPONSE: 'a077ecc9-1a59-48af-b2cd-42a63f5a7f86',
        ESCALATION_RESOLVED_TIMESTAMP: 'c40bf1c4-7d33-4b2b-8765-0784cd88591a'
    };

    // Dropdown UUID mapping for ESCALATION_STATUS
    const ESCALATION_STATUS_VALUES = {
        'ESCALATED': '8dc15846-e8c7-43a8-b7b2-1e1a0e1d6497',
        'RESOLVED': 'cbf82936-5488-4612-93a7-f8161071b0eb'
    };

    // Helper to resolve dropdown value to readable value
    function getDropdownValue(field) {
        if (!field || field.value === null || field.value === undefined) return null;
        
        // Special handling for ESCALATION_STATUS dropdown
        if (field.id === FIELD_IDS.ESCALATION_STATUS) {
            // ClickUp stores dropdown values as orderindex integers
            // Based on the field structure: 0="Not Escalated", 1="Escalated", 2="Resolved"
            if (field.value === 0) return 'NOT_ESCALATED';
            if (field.value === 1) return 'ESCALATED';
            if (field.value === 2) return 'RESOLVED';
            
            // Fallback: check for UUID values (in case API changes)
            if (field.value === ESCALATION_STATUS_VALUES.ESCALATED) return 'ESCALATED';
            if (field.value === ESCALATION_STATUS_VALUES.RESOLVED) return 'RESOLVED';
        }
        
        return field.value; // fallback to raw value
    }

    // Helper to get custom field value
    function getCustomField(task, fieldId) {
        if (!task?.custom_fields) return null;
        const field = task.custom_fields.find(f => f.id === fieldId);
        return field?.value || null;
    }

    // Helper to get escalation status as readable string
    function getEscalationStatus(task) {
        if (!task?.custom_fields) return null;
        const field = task.custom_fields.find(f => f.id === FIELD_IDS.ESCALATION_STATUS);
        return getDropdownValue(field);
    }

    // Helper to get non-empty custom fields
    function getNonEmptyCustomFields(task) {
        if (!task?.custom_fields) return [];
        
        return task.custom_fields
            .filter(field => {
                // Skip escalation fields (shown separately)
                if (Object.values(FIELD_IDS).includes(field.id)) return false;
                // Skip empty values
                if (!field.value) return false;
                if (field.value === '') return false;
                if (field.value === 0 && field.type !== 'number') return false;
                return true;
            })
            .map(field => ({
                id: field.id,
                name: field.name,
                value: field.value,
                type: field.type
            }));
    }

    // Format custom field value for display
    function formatFieldValue(field) {
        if (field.type === 'date') {
            return new Date(field.value).toLocaleDateString();
        }
        if (field.type === 'number') {
            return field.value.toLocaleString();
        }
        if (field.type === 'drop_down') {
            // For dropdowns, value might be an object
            if (typeof field.value === 'object') {
                return field.value.name || field.value.value || 'Selected';
            }
        }
        return String(field.value);
    }

    // Reusable Collapsible Section Component
    function CollapsibleSection({ title, icon, children, defaultExpanded = false, badge = null }) {
        const [expanded, setExpanded] = useState(defaultExpanded);
        
        return (
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div 
                    className="px-4 py-3 bg-gray-50 border-b cursor-pointer hover:bg-gray-100 transition-colors"
                    onClick={() => setExpanded(!expanded)}
                >
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-2">
                            <span className="text-lg">{icon}</span>
                            <h3 className="text-sm font-semibold text-gray-700">{title}</h3>
                            {badge && (
                                <span className="ml-2 bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs font-normal">
                                    {badge}
                                </span>
                            )}
                        </div>
                        <svg 
                            className={`w-4 h-4 text-gray-400 transition-transform ${expanded ? 'rotate-90' : ''}`}
                            fill="none" 
                            stroke="currentColor" 
                            viewBox="0 0 24 24"
                        >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                </div>
                
                <div className={`accordion-content ${expanded ? 'show' : ''}`}>
                    {expanded && <div className="p-4">{children}</div>}
                </div>
            </div>
        );
    }
    
    // Task Header Component - Shows task context with breadcrumb
    function TaskHeader({ task, parentTask }) {
        if (!task) return null;
        
        return (
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                {/* Parent Task Context (if exists) */}
                {parentTask && (
                    <div className="p-3 bg-blue-50 border-b border-blue-200">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <span className="text-xs font-semibold text-blue-700 uppercase tracking-wider">
                                    üè¢ Parent Task
                                </span>
                                <span className="text-xs text-blue-600">{parentTask.name}</span>
                            </div>
                            {parentTask.custom_id && (
                                <a
                                    href={`https://app.clickup.com/t/${parentTask.id}`}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-xs text-blue-600 hover:text-blue-800 hover:underline font-mono"
                                >
                                    {parentTask.custom_id}
                                </a>
                            )}
                        </div>
                    </div>
                )}
                
                {/* Current Task Header */}
                <div className="p-4">
                    <div className="flex items-center justify-between mb-2">
                        <h2 className="text-lg font-semibold text-gray-900">{task.name}</h2>
                        {task.custom_id && (
                            <a
                                href={`https://app.clickup.com/t/${task.id}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-xs text-blue-600 hover:text-blue-800 hover:underline font-mono"
                            >
                                {task.custom_id}
                            </a>
                        )}
                    </div>
                    
                    {/* Task Metadata */}
                    <div className="flex items-center space-x-4 text-xs">
                        {task.status && (
                            <div className="flex items-center">
                                <span
                                    className="inline-block w-2 h-2 rounded-full mr-1"
                                    style={{ backgroundColor: task.status.color || '#6b7280' }}
                                ></span>
                                <span className="text-gray-600">{task.status.status}</span>
                            </div>
                        )}
                        {task.due_date && (
                            <div className="text-gray-600">
                                Due: {new Date(task.due_date).toLocaleDateString()}
                            </div>
                        )}
                        {task.assignees?.length > 0 && (
                            <div className="text-gray-600">
                                üë§ {task.assignees.map(a => a.username).join(', ')}
                            </div>
                        )}
                        {task.priority && (
                            <div className="text-gray-600">
                                Priority: {task.priority.priority || 'None'}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }
    
    // Comments Section Component
    function CommentsSection({ task }) {
        const [comments, setComments] = useState([]);
        const [loading, setLoading] = useState(false);
        const [hasMore, setHasMore] = useState(false);
        const [expandedComments, setExpandedComments] = useState(new Set());
        const [expanded, setExpanded] = useState(false);
        
        const loadComments = async () => {
            if (!task?.id || loading) return;
            
            setLoading(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/task/${task.id}/comments?limit=5`, {
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    window.location.href = '/auth/login';
                    return;
                }
                
                if (response.ok) {
                    const data = await response.json();
                    setComments(data.comments || []);
                    setHasMore(data.has_more || false);
                }
            } catch (error) {
                console.error('Error loading comments:', error);
            } finally {
                setLoading(false);
            }
        };
        
        const loadMoreComments = async () => {
            if (!task?.id || loading) return;
            
            setLoading(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/task/${task.id}/comments?start=${comments.length}&limit=5`, {
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    setComments(prev => [...prev, ...(data.comments || [])]);
                    setHasMore(data.has_more || false);
                }
            } catch (error) {
                console.error('Error loading more comments:', error);
            } finally {
                setLoading(false);
            }
        };
        
        const toggleCommentExpansion = (commentId) => {
            setExpandedComments(prev => {
                const newSet = new Set(prev);
                if (newSet.has(commentId)) {
                    newSet.delete(commentId);
                } else {
                    newSet.add(commentId);
                }
                return newSet;
            });
        };
        
        useEffect(() => {
            if (expanded && comments.length === 0) {
                loadComments();
            }
        }, [expanded]);
        
        return (
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div 
                    className="px-4 py-3 bg-gray-50 border-b cursor-pointer hover:bg-gray-100 transition-colors"
                    onClick={() => setExpanded(!expanded)}
                >
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-2">
                            <span className="text-lg">üí¨</span>
                            <h3 className="text-sm font-semibold text-gray-700">Recent Activity</h3>
                            {comments.length > 0 && (
                                <span className="ml-2 bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs font-normal">
                                    {comments.length}
                                </span>
                            )}
                        </div>
                        <svg 
                            className={`w-4 h-4 text-gray-400 transition-transform ${expanded ? 'rotate-90' : ''}`}
                            fill="none" 
                            stroke="currentColor" 
                            viewBox="0 0 24 24"
                        >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                </div>
                
                <div className={`accordion-content ${expanded ? 'show' : ''}`}>
                    {expanded && (
                        <div className="p-4">
                            {loading && comments.length === 0 ? (
                                <div className="text-center py-4">
                                    <div className="spinner-sm mx-auto"></div>
                                    <p className="text-xs text-gray-500 mt-2">Loading comments...</p>
                                </div>
                            ) : comments.length === 0 ? (
                                <p className="text-center py-4 text-gray-500 text-sm">No comments yet</p>
                            ) : (
                                <div className="space-y-3 max-h-96 overflow-y-auto">
                                    {comments.map((comment) => (
                                        <div key={comment.id} className="border-l-2 border-gray-200 pl-3">
                                            <div className="flex items-start gap-2">
                                                <div 
                                                    className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium text-white flex-shrink-0"
                                                    style={{ backgroundColor: comment.user?.color || '#808080' }}
                                                >
                                                    {comment.user?.initials || '??'}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                                        <span className="font-medium">{comment.user?.username || 'Unknown'}</span>
                                                        <span>‚Ä¢</span>
                                                        <span>{comment.date_formatted || 'No date'}</span>
                                                    </div>
                                                    <div className="text-sm text-gray-700 mt-1 break-words">
                                                        {comment.text && comment.text.length > 100 ? (
                                                            <>
                                                                {expandedComments.has(comment.id) 
                                                                    ? comment.text 
                                                                    : `${comment.text.substring(0, 100)}...`
                                                                }
                                                                <button 
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        toggleCommentExpansion(comment.id);
                                                                    }}
                                                                    className="text-blue-600 text-xs ml-1 hover:underline"
                                                                >
                                                                    {expandedComments.has(comment.id) ? 'show less' : 'show more'}
                                                                </button>
                                                            </>
                                                        ) : (
                                                            comment.text || 'No comment text'
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {hasMore && (
                                        <div className="text-center pt-2">
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    loadMoreComments();
                                                }}
                                                disabled={loading}
                                                className="text-xs text-blue-600 hover:text-blue-800 hover:underline disabled:opacity-50"
                                            >
                                                {loading ? 'Loading...' : 'Load more'}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );
    }
    
    // Custom Fields Section - Using vanilla JS component for richer display
    function CustomFieldsSection({ task }) {
        const containerRef = useRef(null);
        const sidebarRef = useRef(null);

        useEffect(() => {
            if (containerRef.current && task?.id && !sidebarRef.current) {
                // Initialize sidebar component
                sidebarRef.current = new CustomFieldsSidebar('custom-fields-container');
                sidebarRef.current.render(task.id);
            }
        }, [task]);

        if (!task) return null;

        return (
            <CollapsibleSection
                title="Custom Fields (All)"
                icon="üìä"
                defaultExpanded={false}
            >
                <div id="custom-fields-container" ref={containerRef}></div>
            </CollapsibleSection>
        );
    }

    // Smart Escalation Module - Changes based on state
    function EscalationModule({ task, parentTask, onRefresh }) {
        const [escalationText, setEscalationText] = useState('');
        const [aiSummary, setAiSummary] = useState('');
        const [supervisorText, setSupervisorText] = useState('');
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [isGenerating, setIsGenerating] = useState(false);
        
        // Get escalation field values
        const reason = getCustomField(task, FIELD_IDS.ESCALATION_REASON);
        const summary = getCustomField(task, FIELD_IDS.ESCALATION_AI_SUMMARY);
        const status = getCustomField(task, FIELD_IDS.ESCALATION_STATUS);
        const supervisorResponse = getCustomField(task, FIELD_IDS.SUPERVISOR_RESPONSE);
        const escalatedTo = getCustomField(task, FIELD_IDS.ESCALATED_TO);
        const escalationTime = getCustomField(task, FIELD_IDS.ESCALATION_TIMESTAMP);
        const resolvedTime = getCustomField(task, FIELD_IDS.ESCALATION_RESOLVED_TIMESTAMP);
        
        // Determine escalation state using proper UUID mapping
        const escalationStatus = getEscalationStatus(task);
        const isEscalated = escalationStatus === 'ESCALATED' || reason || summary;
        const isResolved = escalationStatus === 'RESOLVED' || supervisorResponse;
        const isAwaitingResponse = isEscalated && !isResolved;
        
        // No role checking needed - ANYONE can respond to escalations
        
        // Generate AI Summary
        const generateSummary = async () => {
            if (!escalationText.trim()) {
                alert('Please provide an escalation reason first');
                return;
            }
            
            setIsGenerating(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/ai/generate-escalation-summary`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: task.id,
                        reason: escalationText,
                        context: {
                            task: task || {},  // Ensure we never send null
                            parent_task: parentTask || {}  // Ensure we never send null
                        }
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    setAiSummary(data.summary);
                } else {
                    // Handle error response
                    const errorMessage = data.error || 'Failed to generate AI summary';
                    const technicalError = data.technical_error ? `\n\nTechnical details: ${data.technical_error}` : '';
                    alert(errorMessage + technicalError);
                    console.error('AI generation error:', data);
                }
            } catch (error) {
                console.error('Error generating summary:', error);
                alert('Error generating AI summary');
            } finally {
                setIsGenerating(false);
            }
        };
        
        // Submit Escalation
        const submitEscalation = async () => {
            setIsSubmitting(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/task-helper/escalate/${task.id}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: escalationText,
                        ai_summary: aiSummary,
                        escalated_to: '', // TODO: Add supervisor selection
                        task_context: {
                            task_id: task.id,
                            task_name: task.name,
                            parent_task_id: parentTask?.id
                        }
                    })
                });
                
                if (response.ok) {
                    alert('Escalation submitted successfully!');
                    // Refresh page to show updated state
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('Failed to submit escalation');
                }
            } catch (error) {
                console.error('Error submitting escalation:', error);
                alert('Error submitting escalation');
            } finally {
                setIsSubmitting(false);
            }
        };
        
        // Submit Supervisor Response
        const submitSupervisorResponse = async () => {
            setIsSubmitting(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/task-helper/supervisor-response/${task.id}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        response: supervisorText
                    })
                });
                
                if (response.ok) {
                    alert('Response recorded successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('Failed to submit response');
                }
            } catch (error) {
                console.error('Error submitting response:', error);
                alert('Error submitting response');
            } finally {
                setIsSubmitting(false);
            }
        };
        
        // RESOLVED STATE
        if (isResolved) {
            return (
                <div className="bg-green-50 rounded-lg p-6">
                    <div className="flex items-center mb-4">
                        <span className="text-2xl mr-3">‚úÖ</span>
                        <div>
                            <h3 className="text-lg font-semibold text-green-900">Escalation Resolved</h3>
                            <p className="text-sm text-green-700">
                                Resolved on {resolvedTime ? new Date(resolvedTime).toLocaleString() : 'Unknown'}
                            </p>
                        </div>
                    </div>
                    
                    <div className="space-y-4">
                        {reason && (
                            <div>
                                <h4 className="text-sm font-semibold text-gray-700 mb-1">Original Reason</h4>
                                <p className="text-sm text-gray-600 bg-white p-3 rounded">{reason}</p>
                            </div>
                        )}
                        
                        {supervisorResponse && (
                            <div>
                                <h4 className="text-sm font-semibold text-green-700 mb-1">Resolution Response</h4>
                                <p className="text-sm text-gray-700 bg-white p-3 rounded">{supervisorResponse}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        // AWAITING RESPONSE STATE
        if (isAwaitingResponse) {
            return (
                <div className="bg-yellow-50 rounded-lg p-6">
                    <div className="flex items-center mb-4">
                        <span className="text-2xl mr-3">‚è≥</span>
                        <div>
                            <h3 className="text-lg font-semibold text-yellow-900">Escalation Pending</h3>
                            <p className="text-sm text-yellow-700">
                                Escalated on {escalationTime ? new Date(escalationTime).toLocaleString() : 'Unknown'}
                            </p>
                        </div>
                    </div>
                    
                    <div className="space-y-4">
                        {reason && (
                            <div>
                                <h4 className="text-sm font-semibold text-gray-700 mb-1">Escalation Reason</h4>
                                <p className="text-sm text-gray-600 bg-white p-3 rounded">{reason}</p>
                            </div>
                        )}
                        
                        {summary && (
                            <div>
                                <h4 className="text-sm font-semibold text-blue-700 mb-1">AI Summary</h4>
                                <p className="text-sm text-gray-600 bg-white p-3 rounded">{summary}</p>
                            </div>
                        )}
                        
                        {/* Response Form - ANYONE can respond */}
                        <div className="border-t pt-4">
                            <h4 className="text-sm font-semibold text-gray-700 mb-2">Provide Response</h4>
                            <textarea
                                value={supervisorText}
                                onChange={(e) => setSupervisorText(e.target.value)}
                                className="w-full p-3 border rounded-md text-sm"
                                rows="4"
                                placeholder="Enter your response and instructions..."
                            />
                            <button
                                onClick={submitSupervisorResponse}
                                disabled={!supervisorText.trim() || isSubmitting}
                                className="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                            >
                                {isSubmitting ? 'Submitting...' : 'Submit Response'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        // NOT ESCALATED STATE - Show form
        return (
            <div className="bg-white rounded-lg p-6 border border-gray-200">
                <div className="flex items-center mb-4">
                    <span className="text-2xl mr-3">üö®</span>
                    <h3 className="text-lg font-semibold text-gray-900">Escalate Task</h3>
                </div>
                
                <div className="space-y-4">
                    {/* Step 1: Reason */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Why does this task need escalation?
                        </label>
                        <textarea
                            value={escalationText}
                            onChange={(e) => setEscalationText(e.target.value)}
                            className="w-full p-3 border rounded-md text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            rows="4"
                            placeholder="Describe the issue and why it needs attention..."
                        />
                    </div>
                    
                    {/* Step 2: AI Summary */}
                    {escalationText && (
                        <div>
                            <button
                                onClick={generateSummary}
                                disabled={isGenerating}
                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
                            >
                                {isGenerating ? 'Generating...' : 'ü§ñ Generate AI Summary'}
                            </button>
                            
                            {aiSummary && (
                                <div className="mt-3 p-3 bg-blue-50 rounded">
                                    <h4 className="text-sm font-semibold text-blue-700 mb-1">AI Summary</h4>
                                    <p className="text-sm text-gray-700">{aiSummary}</p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Submit Button */}
                    {escalationText && aiSummary && (
                        <button
                            onClick={submitEscalation}
                            disabled={isSubmitting}
                            className="w-full px-4 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 font-semibold"
                        >
                            {isSubmitting ? 'Submitting...' : 'üö® Submit Escalation'}
                        </button>
                    )}
                </div>
            </div>
        );
    }

    // Main App Component
    function TaskHelperApp() {
        const [loading, setLoading] = useState(true);
        const [task, setTask] = useState(null);
        const [parentTask, setParentTask] = useState(null);
        const [error, setError] = useState(null);
        
        useEffect(() => {
            loadTaskData();
        }, []);
        
        async function loadTaskData() {
            try {
                // Get task ID from URL
                const params = new URLSearchParams(window.location.search);
                const taskId = params.get('task_id');
                
                if (!taskId) {
                    throw new Error('No task_id parameter provided');
                }
                
                // Fetch task data using task-helper initialization endpoint
                const response = await fetch(`${BACKEND_URL}/api/task-helper/initialize/${taskId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/auth/login';
                        return;
                    }
                    throw new Error('Failed to load task');
                }
                
                const data = await response.json();
                setTask(data.main_task || data.wait_task);
                setParentTask(data.parent_task);
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        }
        
        if (loading) {
            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                    <div className="text-center">
                        <div className="spinner mx-auto mb-4"></div>
                        <p className="text-gray-600">Loading task data...</p>
                    </div>
                </div>
            );
        }
        
        if (error) {
            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                    <div className="text-center text-red-600">
                        <p className="text-xl mb-2">Error</p>
                        <p>{error}</p>
                    </div>
                </div>
            );
        }
        
        return (
            <div className="min-h-screen bg-gray-50">
                {/* Header */}
                <div className="bg-white shadow-sm border-b">
                    <div className="max-w-6xl mx-auto px-4 py-4">
                        <h1 className="text-xl font-semibold text-gray-900">
                            üö® Escalation Response System
                        </h1>
                    </div>
                </div>
                
                {/* Main Content */}
                <div className="max-w-6xl mx-auto px-4 py-6">
                    <div className="space-y-4">
                        {/* 1. Task Context Header (Always visible) */}
                        <TaskHeader task={task} parentTask={parentTask} />
                        
                        {/* 2. Escalation Module (Primary focus) */}
                        <EscalationModule 
                            task={task} 
                            parentTask={parentTask}
                            onRefresh={loadTaskData}
                        />
                        
                        {/* 3. Comments Section (Collapsible) */}
                        <CommentsSection task={task} />
                        
                        {/* 4. Task Description (Collapsible) */}
                        {task?.description && (
                            <CollapsibleSection title="Task Description" icon="üìù" defaultExpanded={false}>
                                <div className="text-sm text-gray-700">
                                    {task.description}
                                </div>
                            </CollapsibleSection>
                        )}
                        
                        {/* 5. Custom Fields (Collapsible, hidden by default) */}
                        <CustomFieldsSection task={task} />
                        
                        {/* 6. Attachments (if any) */}
                        {task?.attachments?.length > 0 && (
                            <CollapsibleSection 
                                title={`Attachments`} 
                                icon="üìé"
                                badge={task.attachments.length}
                                defaultExpanded={false}
                            >
                                <div className="space-y-2">
                                    {task.attachments.map((attachment, idx) => (
                                        <div key={idx} className="flex items-center space-x-2 text-sm">
                                            <span>üìÑ</span>
                                            <a 
                                                href={attachment.url} 
                                                target="_blank" 
                                                className="text-blue-600 hover:underline"
                                            >
                                                {attachment.title || 'Attachment'}
                                            </a>
                                        </div>
                                    ))}
                                </div>
                            </CollapsibleSection>
                        )}
                    </div>
                </div>
            </div>
        );
    }
    
    // Render the app
    ReactDOM.render(<TaskHelperApp />, document.getElementById('root'));
    {% endraw %}
    </script>
</body>
</html>